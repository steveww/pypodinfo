version: 2.1
jobs:
  info:
    working_directory: /pypodinfo
    docker:
      - image: "docker:20"
    steps:
      - run:
          name: Dump Enviromment
          command: |
            env | sort
      - run:
          name: Tag info
          command: |
            echo "The Git tag is << pipeline.git.tag >>"
            echo "The Git branch is << pipeline.git.branch >>"
  
  build:
    working_directory: /pypodinfo
    docker:
      - image: "docker:20"
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install extras
          command: |
            apk update
            apk add --no-cache docker-compose
      - restore_cache:
          keys:
            - v1-{{ .Branch }}
          paths:
            - /caches/pypodinfo.tar
      - run:
          name: Load Docker layer cache
          command: |
            set +o pipefail
            docker load -i /caches/pypodinfo.tar | true
      - run:
          name: Build image
          command: |
            docker build \
            --cache-from=pypodinfo \
            --build-arg="VERSION=${CIRCLE_TAG:-$CIRCLE_SHA1}" \
            -t pypodinfo \
            app
      - run:
          name: Save Docker layer cache
          command: |
            mkdir -p /caches
            docker save -o /caches/pypodinfo.tar pypodinfo
      - save_cache:
          key: v1-{{ .Branch }}-{{ epoch }}
          paths:
            - /caches/pypodinfo.tar
      - deploy:
          name: Push image to registry
          command: |
            docker login -u steveww -p $DOCKERHUB_PASSWD
            docker tag pypodinfo "steveww/pypodinfo:${CIRCLE_TAG:-$CIRCLE_SHA1}"
            docker push "steveww/pypodinfo:${CIRCLE_TAG:-$CIRCLE_SHA1}"

workflows:
  build_publish:
    jobs:
      - info
      - build:
          filters:
            branches:
              only: main
            tags:
              only: /[0-9]+\.[0-9]+\.[0-9]+/
