# Quick Start

All the worker scripts are in the `scripts` subdirectory. These use the Flux CLI to generate manifests on `stdout`.
The helepr scripts below run these worker scripts in batches.

You'll need a GitHub repository created for GitOps management manifests. There's no need to fork this repository,
it's used primarily read-only.

You **must** complete the `Getting Started With Flux` section first. Then you can run helper scripts in order:

1. **00-staging.sh** - This sets up the staging environment. Builds are automatically generated by CircleCI and pushed to Docker Hub. Flux image automation detects the new image, updates manifest in Git where Flux reconciles the change in Kubernetes.
2. **01-production.sh** - This builds on the staging configuration adding progressive delivery (canary release) using Flagger and NGINX Ingress. Similar in operation to staging but using canary roll out.
3. **02-monitoring.sh** - Finally adds in Observability with Prometheus and Grafana.

# Getting Started With Flux

The script in this directory provide the steps to set up Flux.

All the script in this directory except `bootstrap.sh` output YAML on stdout. Redirect this to a file
and copy it into the management repository created by `bootstrap.sh`. Commit and Push the changes.

## Secrets and Bootstrap

The GitRepository requires SSH credentails because the image update automation will want to
push changes into the repository. Create a key pair by running `ssh-credentials.sh`. This
creates the `ssh-credentials.yaml` and prints out the public key. Create the secret in
Kubernetes then delete the file. **DO NOT** push this to GitHub.

```shell
$ kubectl -n flux-system apply -f ssh-credentials.yaml
```

Copy the private key and use it to create a deploy key with write access on GitHub.

Before you can bootstrap Flux, you'll need to edit `bootstrap.sh` and put your details in there. See the Flux
[documentation](https://fluxcd.io/docs/installation/#github-and-github-enterprise) for full details.

Running `bootstrap.sh` will install Flux and set it up to watch your GitOps management GitHub repository.
